{% extends "base.html" %}
{% block title %}
Logo Detection
{% endblock %}
{% block styles %}
<!-- plugins:css -->
<link rel="stylesheet" href="{{ url_for('static',filename='vendors/feather/feather.css')}}">
<link rel="stylesheet" href="{{ url_for('static',filename='vendors/mdi/css/materialdesignicons.min.css')}}">
<link rel="stylesheet" href="{{ url_for('static',filename='vendors/ti-icons/css/themify-icons.css')}}">
<!-- endinject -->
<!-- Plugin css for this page -->
<!-- End plugin css for this page -->
<!-- inject:css -->
<link rel="stylesheet" href="{{ url_for('static',filename='vendors/sweetalert2/sweetalert2.min.css')}}">
<link rel="stylesheet"
  href="{{ url_for('static',filename='vendors/datatables-bs4/css/dataTables.bootstrap4.min.css')}}">
<link rel="stylesheet"
  href="{{ url_for('static',filename='vendors/datatables-responsive/css/responsive.bootstrap4.min.css')}}">
<link rel="stylesheet"
  href="{{ url_for('static',filename='vendors/datatables-buttons/css/buttons.bootstrap4.min.css')}}">
<link rel="stylesheet" href="{{ url_for('static',filename='vendors/datatables-select/css/select.bootstrap4.min.css')}}">
<link rel="stylesheet" href="{{ url_for('static',filename='css/vertical-layout-light/style.css')}}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Dropify/0.2.2/css/dropify.min.css" />
{% endblock %}
{% block navbar %}
<nav class="navbar default-layout col-lg-12 col-12 p-0 fixed-top d-flex align-items-top flex-row">
  <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-start">
    <div class="me-3">
      <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-bs-toggle="minimize">
        <span class="icon-menu"></span>
      </button>
    </div>
    <div>
      <a class="navbar-brand brand-logo" href="">
        <h4>Logo Detection</h4>
      </a>
      <a class="navbar-brand brand-logo-mini" href="">
        <h6></h6>
      </a>
    </div>
  </div>
  <div class="navbar-menu-wrapper d-flex align-items-top">
    <ul class="navbar-nav">
      <li class="nav-item font-weight-semibold d-none d-lg-block ms-0">
        <h1 class="welcome-text"><span class="text-black fw-bold">Logo Detection</span></h1>
        <h3 class="welcome-sub-text">Performance summary</h3>
      </li>
    </ul>
    <ul class="navbar-nav ms-auto">
      <li class="nav-item dropdown d-none d-lg-block user-dropdown">
        <a class="nav-link" id="UserDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
          <img class="img-xs rounded-circle" src="{{ url_for('static',filename='images/Akun.png')}}"
            alt="Profile image"> </a>
        <div class="dropdown-menu dropdown-menu-right navbar-dropdown" aria-labelledby="UserDropdown">
          <div class="dropdown-header text-center">
            <p class="mb-1 mt-3 font-weight-semibold">{{ sessionnya['user_namalengkap'] }}</p>
            <p class="fw-light text-muted mb-0">{{ sessionnya['user_email'] }}</p>
          </div>
          <a class="dropdown-item" href="{{ url_for('logout') }}"><i
              class="dropdown-item-icon mdi mdi-power text-primary me-2"></i>Sign Out</a>
        </div>
      </li>
    </ul>
    <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button"
      data-bs-toggle="offcanvas">
      <span class="mdi mdi-menu"></span>
    </button>
  </div>
</nav>
{% endblock %}
{% block sidebar %}
<nav class="sidebar sidebar-offcanvas" id="sidebar">
  <ul class="nav">
    <li class="nav-item">
      <a class="nav-link" href="{{ url_for('index') }}">
        <i class="mdi mdi-home mdi-grid-large menu-icon"></i>
        <span class="menu-title">Home</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="{{ url_for('generate') }}">
        <i class="mdi mdi-settings mdi-grid-large menu-icon"></i>
        <span class="menu-title">Generate Logo</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="{{ url_for('create_video') }}">
        <i class="mdi mdi-laptop-chromebook mdi-grid-large menu-icon"></i>
        <span class="menu-title">Detect Logo</span>
      </a>
    </li>
  </ul>
</nav>
{% endblock %}
{%block content%}

<!-- partial -->
<div class="main-panel">
  <div class="content-wrapper">
    <div class="row">
      <div class="col-12 grid-margin stretch-card">
        <div class="card">
          <div class="card-body">
            <div class="row mb-2">
              <div class="col-6">
                <h1 class="card-title">Logo</h1>
              </div>
              <div class="col-6">
                <div style="float: right;">
                  <a href="{{ url_for('generate') }}" class="btn btn-primary btn-md btn-icon-text">
                    <i class="ti-plus btn-icon-prepend"></i>
                    Add Logo
                  </a>
                </div>
              </div>
            </div>
            <hr>
            <div class="table-responsive">
              <table class="table table-striped" id="example2">
                <thead>
                  <tr>
                    <th>No</th>
                    <th width="45%">Logo</th>
                    <th>Name</th>
                    <th>Upload Date</th>
                    <th width="20%">
                      Action
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in data %}
                  <tr>
                    <td class="py-1"><label for="">{{ row['num'] }}</label></td>
                    <td><img class="rounded" src="{{ url_for('static',filename='uploads/'+row['logo_filename'])}}"
                        style="width:15% ;height: 15%;">
                    </td>
                    <td>{{ row['logo_nama'] }}</td>
                    <td>{{ row['logo_upload'].strftime('%d %b %Y') }}</td>
                    <td>
                      <a href="{{ url_for('detail', logo_id=row['logo_id']) }}"
                        class="btn btn-info btn-rounded btn-icon">Detail</a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 grid-margin stretch-card">
        <div class="card">
          <div class="card-body">
            <div class="row mb-2">
              <div class="col-6">
                <h1 class="card-title">Video Uploaded</h1>
              </div>
              <div class="col-6">
                <div style="float: right;">
                  <a href="{{ url_for('create_video') }}" class="btn btn-primary btn-md btn-icon-text">
                    <i class="ti-plus btn-icon-prepend"></i>
                    Detect Logo
                  </a>
                </div>
              </div>
            </div>
            <hr>
            <div class="table-responsive">
              <table class="table table-striped" id="example1">
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Filename</th>
                    <th>Logo Detected</th>
                    <th>Ads/minute (Rp.)</th>
                    <th>Total Ads Value (Rp.)</th>
                    <th>Uploaded At</th>
                    <th width="20%">
                      Action
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% if(datavideo) %}
                  {% for row in datavideo %}
                  <tr>
                    <td class="py-1"><label for="">{{ row['num'] }}</label></td>
                    <td>{{ row['video_filename_awal'] }}</td>
                    <td>{{ row['model_nama'] }}</td>
                    <td>Rp. {{ '{:,.2f}'.format(row['ads_rate']) }}</td>
                    <td>Rp. {{ '{:,.2f}'.format(row['total_ads']) }}</td>
                    <td>{{ row['uploaded_at'].strftime('%d %b %Y - %H:%M:%S') }}</td>
                    <td>
                      <a href="{{ url_for('detail_video', video_id=row['video_id']) }}" target="_blank"
                        class="btn btn-info btn-rounded btn-icon">Play</a>
                      <a href="{{ url_for('export', video_id=row['video_id']) }}"
                        class="btn btn-success btn-rounded btn-icon">Export</a>
                    </td>
                  </tr>
                  {% endfor %}
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% if session['user_role'] == 1 %}
      <div class="col-12 grid-margin stretch-card">
        <div class="card">
          <div class="card-body">
            <div class="row mb-2">
              <div class="col-6">
                <h1 class="card-title">Model</h1>
              </div>
              <div class="col-6">
                <div style="float: right;">
                  <a href="#" class="btn btn-primary btn-md btn-icon-text" data-bs-toggle="modal" data-bs-target="#add">
                    <i class="ti-plus btn-icon-prepend"></i>
                    Add Model
                  </a>
                </div>
              </div>
            </div>
            <hr>
            <div class="table-responsive">
              <table class="table table-striped" id="example1">
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Name Model</th>
                    <th>Weights Model</th>
                    <th>Config Model</th>
                    <th>Label Model</th>
                    <th width="20%">
                      Action
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% if(data_model) %}
                  {% for row in data_model %}
                  <tr>
                    <td class="py-1"><label for="">{{ row['num'] }}</label></td>
                    <td>{{ row['model_nama'] }}</td>
                    <td>{{ row['model_weights'] }}</td>
                    <td>{{ row['model_cfg'] }}</td>
                    <td>{{ row['model_label'] }}</td>
                    <td>
                      <a href="" class="btn btn-info btn-rounded btn-icon" data-bs-toggle="modal" data-bs-target="#edit" onclick="showedit(this)" data-id="{{ row['model_id'] }}" data-name="{{ row['model_nama'] }}" data-weights="{{ row['model_weights'] }}" data-cfg="{{ row['model_cfg'] }}" data-label="{{ row['model_label'] }}">Edit</a>
                      <a href="" class="btn btn-success btn-rounded btn-icon">Hapus</a>
                    </td>
                  </tr>
                  {% endfor %}
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
  <div class="modal fade" id="add" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Add Model</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form action="" method="POST" id="form_add" enctype="multipart/form-data">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-12">
                <div class="row">
                  <div class="form-group">
                    <label>Model Name</label>
                    <input type="text" class="form-control" name="model_name" id="model_name" placeholder="Name Model" aria-label="Name Model">
                  </div>
                </div>
                <div class="row">
                  <div class="form-group">
                    <label>Model Weight</label>
                    <div class="col-sm-12">
                      <div class="custom-file">
                        <input type="file" name="model_weights" id="model_weights" class="dropify" data-allowed-file-extensions="weights" required>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="form-group">
                    <label>Model Config</label>
                    <div class="col-sm-12">
                      <div class="custom-file">
                        <input type="file" name="model_config" id="model_config" class="dropify" data-allowed-file-extensions="cfg" required>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="form-group">
                    <label>Model Label</label>
                    <div class="col-sm-12">
                      <div class="custom-file">
                        <input type="file" name="model_label" id="model_label" class="dropify" data-allowed-file-extensions="names" required>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" id="edit" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Edit Model</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form action="" method="POST" id="form_edit" enctype="multipart/form-data">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-12">
                <div class="row">
                  <div class="form-group">
                    <label>Model Name</label>
                    <input type="text" class="form-control" name="model_name" id="model_name" placeholder="Name Model" aria-label="Name Model">
                  </div>
                </div>
                <div class="row">
                  <div class="form-group">
                    <label>Model Weight</label>
                    <div class="col-sm-12">
                      <div class="custom-file">
                        <input type="file" name="model_weights" id="model_weights" class="dropify" data-allowed-file-extensions="weights" required>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="form-group">
                    <label>Model Config</label>
                    <div class="col-sm-12">
                      <div class="custom-file">
                        <input type="file" name="model_config" id="model_config" class="dropify" data-allowed-file-extensions="cfg" required>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="form-group">
                    <label>Model Label</label>
                    <div class="col-sm-12">
                      <div class="custom-file">
                        <input type="file" name="model_label" id="model_label" class="dropify" data-allowed-file-extensions="names" required>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- content-wrapper ends -->
  {% endblock %}
  {%block scripts %}
  <!-- plugins:js -->
  <script src="{{ url_for('static',filename='vendors/js/vendor.bundle.base.js')}}"></script>
  <script src="{{ url_for('static',filename='js/template.js')}}"></script>
  <script src="{{ url_for('static',filename='js/blockui.js')}}"></script>
  <!-- endinject -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Dropify/0.2.2/js/dropify.min.js"></script>
  <script src="{{ url_for('static',filename='vendors/sweetalert2/sweetalert2.all.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables/jquery.dataTables.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables-bs4/js/dataTables.bootstrap4.min.js')}}"></script>
  <script
    src="{{ url_for('static',filename='vendors/datatables-responsive/js/dataTables.responsive.min.js')}}"></script>
  <script
    src="{{ url_for('static',filename='vendors/datatables-responsive/js/responsive.bootstrap4.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables-buttons/js/dataTables.buttons.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables-buttons/js/buttons.bootstrap4.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables-buttons/js/buttons.html5.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables-buttons/js/buttons.print.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables-buttons/js/buttons.colVis.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables-select/js/dataTables.select.min.js')}}"></script>
  <!-- End plugin js for this page -->
  {% endblock %}
  {%block scripting %}
  <script>
    function showedit(elem) {
        var id = $(elem).data('id');
        var model_name= $(elem).data('name');
        var model_weights = $(elem).data('weights');
        var model_cfg= $(elem).data('cfg');
        var model_label = $(elem).data('label');
        console.log(model_name);
        // console.log(jenis);
        $("#form_edit #id").val(id);
        $("#form_edit #model_name").text(model_name);
        $("#form_edit #model_weights").attr("data-default-file",
            'static/models/'+model_name+'/'+model_weights
        );
        $('.dropify').dropify();
        $('.dropify-filename-inner').html(model_weights)
        $('.dropify-preview').css('display', 'block')
        $("#form_edit #model_cfg").attr("data-default-file",
            'static/models/'+model_name+'/'+model_cfg
        );
        $('.dropify').dropify();
        $('.dropify-filename-inner').html(model_cfg)
        $('.dropify-preview').css('display', 'block')
        $("#form_edit #model_label").attr("data-default-file",
            'static/models/'+model_name+'/'+model_label
        );
        $('.dropify').dropify();
        $('.dropify-filename-inner').html(model_label)
        $('.dropify-preview').css('display', 'block')
    }
    $(function () {
      $('.weights-upload-browse').on('click', function () {
        var file = $(this).parent().parent().parent().find('.weight');
        file.trigger('click');
      });
      $('.weight').on('change', function () {
        $(this).parent().find('.form-control').val($(this).val().replace(/C:\\fakepath\\/i, ''));
      });
      $('.config-upload-browse').on('click', function () {
        var file = $(this).parent().parent().parent().find('.config');
        file.trigger('click');
      });
      $('.config').on('change', function () {
        $(this).parent().find('.form-control').val($(this).val().replace(/C:\\fakepath\\/i, ''));
      });
      $('.label_model-upload-browse').on('click', function () {
        var file = $(this).parent().parent().parent().find('.label_model');
        file.trigger('click');
      });
      $('.label_model').on('change', function () {
        $(this).parent().find('.form-control').val($(this).val().replace(/C:\\fakepath\\/i, ''));
      });
      $("#form_add").on("submit", function (e) { //id of form 
            e.preventDefault();
            var form_data = new FormData($('#form_add')[0]);
            // console.log(form_data);
            $.ajax({
              url: '/add_model',
              dataType: 'json',
              contentType: false,
              processData: false,
              data: form_data,
              type: 'POST',
              async: true,
              success: function (d, textStatus, jqXHR) {
                if (d.status) {
                    Swal.fire({
                        icon: 'success',
                        type: 'success',
                        title: d.message,
                        showConfirmButton: true
                    }).then((result) => {
                        location.reload()
                    })
                } else {
                    Swal.fire(
                        'Mohon Maaf!',
                        'Data gagal diperbarui',
                        'error'
                    )
                }
              },
              // }).done(function (d, textStatus, jqXHR) {

            }).fail(function (d, textStatus, jqXHR) {
              console.log(d);
              alert('Failed upload video !!!');
            });
        });
    });
    $(document).ready(function () {
      $('.dropify').dropify({
        messages: {
          'default': '',
          'replace': 'Drag and drop or click to replace',
          'remove': 'Remove',
          'error': 'Ooops, something wrong happended.'
        }
      });
    });
    $('#example1').DataTable({
      "paging": true,
      "lengthChange": true,
      "searching": true,
      "ordering": true,
      "info": true,
      "autoWidth": false,
      "responsive": true,
      "lengthMenu": [
        [10, 25, 50, -1],
        [10, 25, 50, "All"]
      ],
      // "pageLength": 50
    });
    $("#example1").css('width', '100%');
    $('#example2').DataTable({
      "paging": true,
      "lengthChange": true,
      "searching": true,
      "ordering": true,
      "info": true,
      "autoWidth": false,
      "responsive": true,
      "lengthMenu": [
        [10, 25, 50, -1],
        [10, 25, 50, "All"]
      ],
      // "pageLength": 50
    });
    $("#example2").css('width', '100%');
  </script>
  {% endblock %}
{% extends "base.html" %}
{% block title %}
Logo Detection
{% endblock %}
{% block styles %}
<!-- plugins:css -->
<link rel="stylesheet" href="{{ url_for('static',filename='vendors/feather/feather.css')}}">
<link rel="stylesheet" href="{{ url_for('static',filename='vendors/mdi/css/materialdesignicons.min.css')}}">
<!-- endinject -->
<!-- Plugin css for this page -->
<!-- End plugin css for this page -->
<!-- inject:css -->
<link rel="stylesheet" href="{{ url_for('static',filename='vendors/select2/select2.min.css')}}">
<link rel="stylesheet" href="{{ url_for('static',filename='vendors/sweetalert2/sweetalert2.min.css')}}">
<link rel="stylesheet" href="{{ url_for('static',filename='css/vertical-layout-light/style.css')}}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Dropify/0.2.2/css/dropify.min.css" />
<link rel="stylesheet"
  href="{{ url_for('static',filename='vendors/datatables-bs4/css/dataTables.bootstrap4.min.css')}}">
<link rel="stylesheet"
  href="{{ url_for('static',filename='vendors/datatables-responsive/css/responsive.bootstrap4.min.css')}}">
<link rel="stylesheet"
  href="{{ url_for('static',filename='vendors/datatables-buttons/css/buttons.bootstrap4.min.css')}}">
<link rel="stylesheet" href="{{ url_for('static',filename='vendors/datatables-select/css/select.bootstrap4.min.css')}}">
<link rel="stylesheet" href="{{ url_for('static',filename='vendors/ti-icons/css/themify-icons.css')}}">
<style>
  .select2-selection__rendered {
    color: white !important;

  }

  .select2-selection__choice__remove {
    color: white !important;
  }

  .select2 {
    width: 100% !important;
  }

  .dropify-wrapper .dropify-message span.file-icon:before {
    font-size: 5rem !important;
  }

</style>
{% endblock %}
{% block navbar %}
<nav class="navbar default-layout col-lg-12 col-12 p-0 fixed-top d-flex align-items-top flex-row">
  <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-start">
    <div class="me-3">
      <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-bs-toggle="minimize">
        <span class="icon-menu"></span>
      </button>
    </div>
    <div>
      <a class="navbar-brand brand-logo" href="">
        <h4>Logo Detection</h4>
      </a>
      <a class="navbar-brand brand-logo-mini" href="">
        <h6></h6>
      </a>
    </div>
  </div>
  <div class="navbar-menu-wrapper d-flex align-items-top">
    <ul class="navbar-nav">
      <li class="nav-item font-weight-semibold d-none d-lg-block ms-0">
        <h1 class="welcome-text"><span class="text-black fw-bold">Logo Detection</span></h1>
        <h3 class="welcome-sub-text">Performance summary</h3>
      </li>
    </ul>
    <ul class="navbar-nav ms-auto">
      <li class="nav-item dropdown d-none d-lg-block user-dropdown">
        <a class="nav-link" id="UserDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
          <img class="img-xs rounded-circle" src="{{ url_for('static',filename='images/Akun.png')}}"
            alt="Profile image"> </a>
        <div class="dropdown-menu dropdown-menu-right navbar-dropdown" aria-labelledby="UserDropdown">
          <div class="dropdown-header text-center">
            <p class="mb-1 mt-3 font-weight-semibold">{{ sessionnya['user_namalengkap'] }}</p>
            <p class="fw-light text-muted mb-0">{{ sessionnya['user_email'] }}</p>
          </div>
          <a class="dropdown-item" href="{{ url_for('logout') }}"><i
              class="dropdown-item-icon mdi mdi-power text-primary me-2"></i>Sign Out</a>
        </div>
      </li>
    </ul>
    <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button"
      data-bs-toggle="offcanvas">
      <span class="mdi mdi-menu"></span>
    </button>
  </div>
</nav>
{% endblock %}
{% block sidebar %}
<nav class="sidebar sidebar-offcanvas" id="sidebar">
  <ul class="nav">
    <li class="nav-item">
      <a class="nav-link" href="{{ url_for('index') }}">
        <i class="mdi mdi-home mdi-grid-large menu-icon"></i>
        <span class="menu-title">Home</span>
      </a>
    </li>
    <!-- <li class="nav-item">
      <a class="nav-link" href="{{ url_for('generate') }}">
        <i class="mdi mdi-settings mdi-grid-large menu-icon"></i>
        <span class="menu-title">Generate Logo</span>
      </a>
    </li> -->
    <li class="nav-item">
      <a class="nav-link" href="{{ url_for('create_video') }}">
        <i class="mdi mdi-laptop-chromebook mdi-grid-large menu-icon"></i>
        <span class="menu-title">Detect Logo</span>
      </a>
    </li>
  </ul>
</nav>
{% endblock %}
{%block content%}

<!-- partial -->
<div class="main-panel">
  <div class="content-wrapper">
    <div class="row">
      <div class="col-12 grid-margin stretch-card">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title">Upload Video</h4>
            <!-- <p class="card-description">
                Basic form elements
              </p> -->
            <form id="uploadform" method="POST" enctype="multipart/form-data">
              <div class="row">
                <div class="col-6">
                  <div class="row">
                    <label for="gambar" class="col-sm-12 col-form-label">Enter price of rate Ads/minutes&nbsp;<span
                        style="color: red;">(*)</span></label>
                    <div class="col-sm-12">
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <span class="input-group-text bg-primary text-white">Rp. </span>
                        </div>
                        <input type="text" class="form-control uang" id="ads_value" name="ads_value" required>
                        <div class="input-group-append">
                          <span class="input-group-text">.00</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-sm-12">
                      <label id="ads_value-error" class="error mt-2 text-danger" for="ads_value"></label>
                    </div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="row">
                    <label for="gambar" class="col-sm-12 col-form-label">Sponsor&nbsp;<span
                        style="color: red;">(*)</span></label>
                    <div class="col-sm-12">
                      <select name="model_id" id="model_id" class="form-control select2" multiple required
                        placeholder="Pilih Model" style="color: white;">
                        {% for x in data %}
                        <option value="{{ x['model_id']}}">{{ x['model_nama']}}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-sm-12">
                      <label id="model_id-error" class="error mt-2 text-danger" for="model_id"></label>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12">
                  <div class="row">
                    <label for="gambar" class="col-sm-12 col-form-label">Select a video file&nbsp;<span
                        style="color: red;">(*)</span></label>
                    <div class="col-sm-12">
                      <div class="custom-file">
                        <input type="file" name="file_video" id="file_video" class="dropify"
                          data-allowed-file-extensions="mp4" accept="video/*" required>
                      </div>
                    </div>
                    <div class="col-sm-12">
                      <label id="file_video-error" class="error mt-2 text-danger" for="file_video"></label>
                    </div>
                    <!-- <div class="d-flex justify-content-between">
                        <h3 id="progress"></h3>
                        <a id="btn-test" class="btn btn-primary btn-md float-end mt-2">Test</a>
                      </div> -->
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12">
                  <div class="row">
                    <div class="col-8">
                      <div class="progress progress-lg mt-2">
                        <div class="progress-bar bg-success" id="progressBar" role="progressbar"><span id="load_status"></span></div>
                      </div>
                    </div>
                    <!-- <progress class="col-8" id="progressBar" role="progressbar" style="margin-left: 20px;" value="0" max="100" ></progress> -->
                    <div class="col-2 d-flex justify-content-start">
                      <h5 id="status"></h5>
                    </div>
                    <div class="col-2 d-flex justify-content-end" style="margin-left: -20px;">
                      <button id="btn-upload" class="btn btn-primary btn-md mt-2" type="submit">Detect</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-12">
                  <div class="row">
                    <div class="col-12 text-center" id="waiting">
                      
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-12 grid-margin stretch-card">
          <div class="card">
              <div class="card-body">
                <div class="home-tab">
                  <div class="d-sm-flex align-items-center justify-content-between border-bottom">
                    <ul class="nav nav-tabs" role="tablist" id="tabs-nav">
                    </ul>
                  </div>
                  <div class="tab-content tab-content-basic" id="tabs-content">
                  
                  </div>
                </div>
            </div>
        </div>
      </div>
    <!-- <div class="row">
      <div class="col-12 grid-margin stretch-card">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title">Results</h4>
            <div class="row">
              <div class="col-12">
                <div class="row">
                  <div class="col-12">
                    <label for="gambar" class="col-12 col-form-label float-start">Video Process</label>
                    <div class="col-12 text-center">
                      <img src="" class="img-fluid" id="hasilnya" width="500" alt="">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="row mb-2">
              <div class="col-6">
                <h1 class="card-title">Generate Results</h1>
                <p>Results of process detection </p>
              </div>
              <div class="col-6">
                <div style="float: right;">
                  <a href="#" class="btn btn-success btn-md btn-icon-text" id="export">
                    <i class="ti-export btn-icon-prepend"></i>
                    Export (.xls)
                  </a>
                </div>
              </div>
            </div>
            <hr>
            <div>
              <table class="table table-striped" id="example1">
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Logo</th>
                    <th>Start (M : S)</th>
                    <th>End (M : S)</th>
                    <th>Duration (Sec)</th>
                    <th>Ads Value (Rp.)</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div> -->
  </div>
  <!-- content-wrapper ends -->
  {% endblock %}
  {%block scripts %}
  <!-- plugins:js -->
  <script src="{{ url_for('static',filename='vendors/js/vendor.bundle.base.js')}}"></script>
  <script src="{{ url_for('static',filename='js/template.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/jquery-validation/jquery.validate.min.js')}}"></script>
  <script src="{{ url_for('static',filename='js/blockui.js')}}"></script>
  <!-- endinject -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Dropify/0.2.2/js/dropify.min.js"></script>
  <script src="{{ url_for('static',filename='vendors/select2/select2.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/sweetalert2/sweetalert2.all.min.js')}}"></script>
  <!-- End plugin js for this page -->
  <script src="{{ url_for('static',filename='vendors/datatables/jquery.dataTables.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables-bs4/js/dataTables.bootstrap4.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables-responsive/js/dataTables.responsive.min.js')}}">
  </script>
  <script src="{{ url_for('static',filename='vendors/datatables-responsive/js/responsive.bootstrap4.min.js')}}">
  </script>
  <script src="{{ url_for('static',filename='vendors/datatables-buttons/js/dataTables.buttons.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables-buttons/js/buttons.bootstrap4.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables-buttons/js/buttons.html5.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables-buttons/js/buttons.print.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables-buttons/js/buttons.colVis.min.js')}}"></script>
  <script src="{{ url_for('static',filename='vendors/datatables-select/js/dataTables.select.min.js')}}"></script>
  {% endblock %}
  {%block scripting %}
  <script>
    $(document).ready(function () {
      $('.dropify').dropify({
        messages: {
          'default': 'Select files to upload <br>Or drag and drop video files',
          'replace': 'Drag and drop or click to replace',
          'remove': 'Remove',
          'error': 'Ooops, something wrong happended.'
        }
      });
      $('.uang').on('change click keyup input paste', (function (event) {
        $(this).val(function (index, value) {
          var number_string = value.replace(/[^,\d]/g, '').toString(),
            split = number_string.split(','),
            sisa = split[0].length % 3,
            rupiah = split[0].substr(0, sisa),
            ribuan = split[0].substr(sisa).match(/\d{3}/gi);

          // tambahkan titik jika yang di input sudah menjadi angka ribuan
          if (ribuan) {
            separator = sisa ? '.' : '';
            rupiah += separator + ribuan.join('.');
          }

          rupiah = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
          return rupiah
        });
        // $(this).val(function (index, value) {
        //   return value.replace(/(?!\.)\D/g, "").replace(/(?<=\..*)\./g, "").replace(/(?<=\.\d\d).*/g, "")
        //     .replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        // });
      }));
      $(".select2").select2();

      function set_array(data) {
        var in_data = []
        if(data.num == 0){
          var show = "show active"
          var active = "active"
        }else{
          var show = ""
        }
        in_data.push('<li class="nav-item"><a class="nav-link ps-0 '+active+'" id="'+data.model+'-tab" data-bs-toggle="tab" href="#'+data.model+'" role="tab" aria-controls="overview" aria-selected="true"><span class="ms-2 me-2">'+data.model+'</span></a></li>')
        in_data.push('<div class="tab-pane fade '+show+'" id="'+data.model+'" role="tabpanel" aria-labelledby="'+data.model+'-tab"><div class="row"><div class="col-12 grid-margin stretch-card"><div class="card"><div class="card-body"><h4 class="card-title">Results</h4><div class="row"><div class="col-12"><div class="row"><div class="col-12"><label for="gambar" class="col-12 col-form-label float-start">Video Process</label><div class="col-12 text-center"><img src="" class="img-fluid" id="hasilnya'+data.model_id+'" width="500" alt=""></div></div></div></div></div></div></div></div><div class="col-12"><div class="card"><div class="card-body"><div class="row mb-2"><div class="col-6"><h1 class="card-title">Generate Results</h1><p>Results of process detection </p></div></div><hr><div><table class="table table-striped" id="example'+data.model_id+'" style="width: 100%;"><thead><tr> <th>No</th><th>Logo</th><th>Start (M : S)</th><th>End (M : S)</th><th>Duration (Sec)</th><th>Ads Value (Rp.)</th></tr></thead><tbody></tbody></table></div></div></div></div></div>')
        in_data.push(data)
        
        return in_data
      }

      function set_html(all_data) {
        for (let j = 0; j < all_data.length; j++) {
          $("#tabs-nav").append(all_data[j][0])
          $("#tabs-content").append(all_data[j][1])
          $('#hasilnya'+all_data[j][2].model_id+'').attr("src", 'display_video/' + all_data[j][2].filename_akhir);
          $('#example'+all_data[j][2].model_id+'').DataTable({
            destroy: true,
            data: all_data[j][2].datanya,
            columns: [{
                "data": 'num'
              },
              {
                "data": 'model_nama'
              },
              {
                "data": 'start_time'
              },
              {
                "data": 'end_time'
              },
              {
                "data": 'durasi_sec'
              },
              {
                "data": commify('ads_per_menit')
              },
            ],
          });
        }
      }

      function commify(n) {
        var parts = n.toString().split(".");
        const numberPart = parts[0];
        const decimalPart = parts[1];
        const thousands = /\B(?=(\d{3})+(?!\d))/g;
        return numberPart.replace(thousands, ".") + (decimalPart ? "," + decimalPart : "");
      }

      function show_data(datanya) {
        var table = document.getElementById("example1").getElementsByTagName('tbody')[0];
        table.innerHTML = "";
        var tr = "";
        datanya.forEach(x => {
          tr += '<tr>';
          tr += '<td>' + x['num'] + '</td>' + '<td>' + x['model_nama'] + '</td>' + '<td>' + x['start_time'] +
            '</td>' + '<td>' + x['end_time'] + '</td>' + '<td>' + x['durasi_sec'] + '</td>' + '<td>Rp. ' +
            commify(x['ads_per_menit']) + '</td>'
          tr += '</tr>'

        })
        table.innerHTML += tr;
      }
      $("#uploadform").validate({
        rules: {
          model_id: "required",
          file_video: "required",
          ads_value: "required"
        },
        messages: {
          model_id: "Please select your sponsor",
          file_video: "Please select your video",
          ads_value: "Please enter your price"
        },
        errorPlacement: function (label, element) {
          label.addClass('mt-2 text-danger');
          label.insertAfter(element);
        },
        highlight: function (element, errorClass) {
          $(element).parent().addClass('col-sm-12 has-danger')
          $(element).addClass('form-control-danger')
        },
        submitHandler: function (form) {
          document.getElementById('btn-upload').style.pointerEvents = 'none';
          $.ajax({
            url: '/detect',
            dataType: 'json',
            contentType: false,
            processData: false,
            data: new FormData($(form)[0]),
            type: 'POST',
            async: true,
            xhr: function () {
              var xhr = new window.XMLHttpRequest();
              xhr.upload.addEventListener("progress", function (event) {
                var percent = (event.loaded / event.total) * 100;
                document.getElementById("progressBar").style.width = Math.round(percent) + "%";
                document.getElementById("status").innerHTML = Math.round(percent) + "% uploaded... please wait";
                document.getElementById("status").classList.add('mt-2');
                document.getElementById("load_status").innerHTML = Math.round(percent) + "%";
              }, false);
              xhr.addEventListener("load", function (event) {
                document.getElementById("status").classList.remove('mt-2');
                document.getElementById("status").innerHTML = 'Uploaded Success';
                document.getElementById("status").classList.add('mt-2');
                document.getElementById("progressBar").style.width = "100%";
                document.getElementById("load_status").innerHTML ="100%";
              }, false);
              return xhr;
            },
            success: function (d, textStatus, jqXHR) {
              let num = d.timing;
              let n = num.toFixed(2);
              $("#waiting").empty()
              for (let i = 0; i < d.model.length; i++) {
                $("#waiting").append('<span class="me-4">Sponsor '+d.model[i]+' Logo</span><div class="lds-ellipsis" id="lds-ellipsis_'+d.model_id[i]+'"><div></div><div></div><div></div><div></div></div><span class="ms-4" id="sponsor_'+d.model_id[i]+'">On Progress</span><br>');
              }
              // var content = '';
              // for (let i = 0; i < d.model.length; i++) {
              //   content += '<span class="me-4">Sponsor '+d.model[i]+' Logo</span><div class="lds-ellipsis" id="lds-ellipsis_'+d.model_id[i]+'"><div></div><div></div><div></div><div></div></div><span class="ms-4" id="sponsor_'+d.model_id[i]+'">On Progress</span><br>';
              // }
              var all_data = []
              var isi = ''
              var isi2 = ''
              for (let i = 0; i < d.model_id.length; i++) {
                // console.log(i);
                // var data = new FormData();
                // data.append('model_id', d.model_id[i]);
                // data.append('ads', d.ads);
                // data.append('filename', d.filename);
                // data.append('video', d.video[i]);
                // aj(data)
                // console.log(content);
                // $('.spinner-border').css('display', 'inline-block');
                // $('.navbar').block({
                //   message: null,
                //   css: {
                //     backgroundColor: 'transparent',
                //     border: '0'
                //   },
                //   overlayCSS: {
                //     backgroundColor: '#fff',
                //     opacity: 0.8
                //   }
                // });
                // $('div.container-scroller').block({
                //   message: '<div class="text-primary" id="waiting">'+content+'</div>',
                //   css: {
                //     backgroundColor: 'transparent',
                //     border: '0'
                //   },
                //   overlayCSS: {
                //     backgroundColor: '#fff',
                //     opacity: 0.8
                //   }
                // });
                setTimeout(function() {
                  $.ajax({
                    url: '/test',
                    data: {
                      model_id: d.model_id[i],
                      ads: d.ads,
                      filename: d.filename,
                      video: d.video[i],
                      num: i,
                      model_name : d.model[i]
                    },
                    type: 'POST',
                    async:false,
                    success: function (data) {
                      $("#sponsor_"+data.model_id+"").empty();
                      $("#lds-ellipsis_"+data.model_id+"").css("display", "none");
                      $("#sponsor_"+data.model_id+"").append(data.status);
                      
                      all_data.push(set_array(data))
                    }
                    
                  });
                  if(d.model.length == all_data.length){
                    set_html(all_data)
                    
                  }
                }, 200);
              }
              // $('.navbar').unblock();
              // $('div.container-scroller').unblock()
              document.getElementById('btn-upload').style.pointerEvents = 'auto';
            },

            // }).done(function (d, textStatus, jqXHR) {

          }).fail(function (d, textStatus, jqXHR) {
            // console.log(d);
            $('.navbar').unblock();
            $('div.container-scroller').unblock()
            alert('Failed upload video !!!');
          });
          return false; // extra insurance preventing the default form action
        }
      });

    });
    
  </script>
  {% endblock %}